<!doctype html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Debug - Bale Mini App</title>
    <script src="https://tapi.bale.ai/miniapp.js?3"></script>
    <style>
        body {
            font-family: Tahoma, Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
            direction: rtl;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            display: inline-block;
            margin: 5px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            direction: ltr;
            text-align: left;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Bale Mini App - Debug Page</h1>

    <div class="card">
        <h2>ÙˆØ¶Ø¹ÛŒØª Bale SDK</h2>
        <div id="sdk-status"></div>
    </div>

    <div class="card">
        <h2>initData</h2>
        <div id="initdata-status"></div>
        <pre id="initdata-value"></pre>
    </div>

    <div class="card">
        <h2>User Info</h2>
        <pre id="user-info"></pre>
    </div>

    <div class="card">
        <h2>Platform Info</h2>
        <pre id="platform-info"></pre>
    </div>

    <div class="card">
        <h2>ØªØ³Øª API</h2>
        <button onclick="testAPI()">ØªØ³Øª ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…</button>
        <div id="api-result"></div>
    </div>

    <div class="card">
        <button onclick="window.location.href='/welfare/mini-app/'">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…ÛŒÙ†ÛŒâ€ŒØ§Ù¾</button>
    </div>

    <script>
        function checkSDK() {
            const sdkStatus = document.getElementById('sdk-status');
            const initdataStatus = document.getElementById('initdata-status');
            const initdataValue = document.getElementById('initdata-value');
            const userInfo = document.getElementById('user-info');
            const platformInfo = document.getElementById('platform-info');

            // Check SDK
            if (window.Bale && window.Bale.WebApp) {
                sdkStatus.innerHTML = '<div class="status success">âœ… Bale SDK Ù„ÙˆØ¯ Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';

                // Check initData
                const initData = window.Bale.WebApp.initData;
                if (initData) {
                    initdataStatus.innerHTML = '<div class="status success">âœ… initData Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª</div>';
                    initdataValue.textContent = initData;

                    // Parse initData
                    const params = new URLSearchParams(initData);
                    const userData = {};
                    for (const [key, value] of params.entries()) {
                        if (key === 'user') {
                            userData[key] = JSON.parse(decodeURIComponent(value));
                        } else {
                            userData[key] = value;
                        }
                    }
                    userInfo.textContent = JSON.stringify(userData, null, 2);
                } else {
                    initdataStatus.innerHTML = '<div class="status error">âŒ initData Ø®Ø§Ù„ÛŒ Ø§Ø³Øª<br><small>Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø¨Ø§ÛŒØ¯ Ø§Ø² Ø¯Ø§Ø®Ù„ Ø¨Ù„Ù‡ Ø¨Ø§Ø² Ø´ÙˆØ¯</small></div>';
                    initdataValue.textContent = 'Ø®Ø§Ù„ÛŒ';
                }

                // Platform info
                const platform = {
                    version: window.Bale.WebApp.version,
                    platform: window.Bale.WebApp.platform,
                    colorScheme: window.Bale.WebApp.colorScheme,
                    isExpanded: window.Bale.WebApp.isExpanded,
                    viewportHeight: window.Bale.WebApp.viewportHeight,
                    viewportStableHeight: window.Bale.WebApp.viewportStableHeight
                };
                platformInfo.textContent = JSON.stringify(platform, null, 2);
            } else {
                sdkStatus.innerHTML = '<div class="status error">âŒ Bale SDK Ù„ÙˆØ¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
                initdataStatus.innerHTML = '<div class="status error">âŒ SDK Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª</div>';
            }
        }

        async function testAPI() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.innerHTML = '<div style="padding: 10px;">Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª...</div>';

            const initData = window.Bale?.WebApp?.initData;
            if (!initData) {
                resultDiv.innerHTML = '<div class="status error">âŒ initData Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</div>';
                return;
            }

            try {
                const response = await fetch('/welfare/api/mini-app/auth/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ initData })
                });

                const data = await response.json();

                if (response.ok) {
                    resultDiv.innerHTML = '<div class="status success">âœ… ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚</div><pre>' +
                        JSON.stringify(data, null, 2) + '</pre>';
                } else {
                    resultDiv.innerHTML = '<div class="status error">âŒ Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯</div><pre>' +
                        JSON.stringify(data, null, 2) + '</pre>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="status error">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±</div><pre>' +
                    error.message + '</pre>';
            }
        }

        // Auto-check on load
        if (window.Bale && window.Bale.WebApp) {
            window.Bale.WebApp.ready();
        }

        setTimeout(checkSDK, 500);
        setInterval(checkSDK, 5000); // Refresh every 5 seconds
    </script>
</body>
</html>
