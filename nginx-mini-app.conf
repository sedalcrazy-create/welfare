# Nginx Configuration for Bale Mini App
# Add this to your existing nginx config for the welfare site

server {
    listen 80;
    listen [::]:80;
    server_name ria.jafamhis.ir;

    # Root directory
    root /var/www/welfare/public;
    index index.php index.html;

    # Logs
    access_log /var/log/nginx/welfare-access.log;
    error_log /var/log/nginx/welfare-error.log;

    # Main Laravel application
    location /welfare {
        alias /var/www/welfare/public;
        try_files $uri $uri/ @laravel;

        # PHP processing
        location ~ \.php$ {
            include fastcgi_params;
            fastcgi_pass unix:/var/run/php/php8.2-fpm.sock; # Adjust PHP version if needed
            fastcgi_param SCRIPT_FILENAME /var/www/welfare/public/index.php;
            fastcgi_param PATH_INFO $fastcgi_path_info;
        }
    }

    # Bale Mini App - Static files (IMPORTANT!)
    location /welfare/mini-app {
        alias /var/www/welfare/public/mini-app;
        try_files $uri $uri/ /welfare/mini-app/index.html;

        # Cache static assets
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        # Don't cache index.html
        location = /welfare/mini-app/index.html {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires 0;
        }

        # CORS headers for Bale
        add_header Access-Control-Allow-Origin "https://tapp-api.bale.ai" always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    }

    # API routes
    location /welfare/api {
        try_files $uri $uri/ /welfare/index.php?$query_string;
    }

    # Laravel fallback
    location @laravel {
        rewrite ^/welfare/(.*)$ /welfare/index.php?$1 last;
    }

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Deny access to hidden files
    location ~ /\. {
        deny all;
    }

    # Deny access to sensitive files
    location ~* (\.env|\.git|composer\.json|composer\.lock|package\.json) {
        deny all;
    }

    # PHP-FPM status (optional)
    location ~ ^/(fpm-status|fpm-ping)$ {
        access_log off;
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }
}

# SSL Configuration (if you have HTTPS)
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name ria.jafamhis.ir;

    # SSL certificates
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;

    # SSL settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Same configuration as above
    root /var/www/welfare/public;
    index index.php index.html;

    access_log /var/log/nginx/welfare-ssl-access.log;
    error_log /var/log/nginx/welfare-ssl-error.log;

    # Main Laravel application
    location /welfare {
        alias /var/www/welfare/public;
        try_files $uri $uri/ @laravel;

        location ~ \.php$ {
            include fastcgi_params;
            fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
            fastcgi_param SCRIPT_FILENAME /var/www/welfare/public/index.php;
            fastcgi_param PATH_INFO $fastcgi_path_info;
        }
    }

    # Bale Mini App
    location /welfare/mini-app {
        alias /var/www/welfare/public/mini-app;
        try_files $uri $uri/ /welfare/mini-app/index.html;

        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        location = /welfare/mini-app/index.html {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires 0;
        }

        add_header Access-Control-Allow-Origin "https://tapp-api.bale.ai" always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    }

    location /welfare/api {
        try_files $uri $uri/ /welfare/index.php?$query_string;
    }

    location @laravel {
        rewrite ^/welfare/(.*)$ /welfare/index.php?$1 last;
    }

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    location ~ /\. {
        deny all;
    }

    location ~* (\.env|\.git|composer\.json|composer\.lock|package\.json) {
        deny all;
    }
}
