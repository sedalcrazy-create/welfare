# โ ฺฏุฒุงุฑุด ูพุงุฏูโุณุงุฒ ุณุณุชู ูุฏุฑุช ูููุงูุงู

**ุชุงุฑุฎ:** 1404/11/26
**ูุณุฎู:** Phase 1 Complete
**ูุถุนุช:** โ ุขูุงุฏู ุชุณุช ู ุงุณุชูุงุฏู

---

## ๐ ุฎูุงุตู ุงุฌุฑุง

ุณุณุชู ูุฏุฑุช ูููุงูุงู ุจุง ููููุช ูพุงุฏูโุณุงุฒ ุดุฏ. ุงู ุณุณุชู ุงูฺฉุงู ูโุฏูุฏ:

1. **ูููุงูุงู ฺฉุชุง** (ุจุฑ ุงุณุงุณ ฺฉุฏ ูู) ุซุจุช ุดููุฏ
2. **ฺฉ ูููุงู** ุจุง **ฺูุฏ ูพุฑุณูู** ูุฑุชุจุท ุจุงุดุฏ (ูุซูุงู ูุงุฏุฑ ุจุง ุฏู ูพุณุฑ)
3. **ุฏุณุชูโุจูุฏ ุฎูุฏฺฉุงุฑ** ูููุงูุงู ุจู ุจุงูฺฉ/ูุชูุฑูู
4. **ุงูุชุฎุงุจ ูููุงูุงู** ุจุฑุง ูุฑ ุณูุฑ (ูุงุจู ูุฑุงุด)
5. **ุฑุฏุงุจ** ุงูฺฉู ฺู ูููุงูุงู ุจุง ฺฉุฏุงู ูพุฑุณูู ุณูุฑ ฺฉุฑุฏูุฏ

---

## ๐ฏ ููุงูู ุณูโฺฏุงูู

```
โโโโโโโโโโโโโโโโโโโ
โ 1. PERSONNEL    โ  ูพุฑุณูู (ุดุงุบู/ุจุงุฒูุดุณุชู) - ุณููู ุฏุงุฑุฏ โ
โโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโ
โ 2. BENEFICIARIESโ  ูุธููโุจฺฏุฑุงู (ุขูุฏู) - ุณููู ุฏุงุฑุฏ โ
โโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโ
โ 3. GUESTS       โ  ูููุงูุงู (ููุฑุงู) - ุณููู ูุฏุงุฑุฏ โ
โโโโโโโโโโโโโโโโโโโ
```

---

## ๐ ูุงูโูุง ุงุฌุงุฏ/ุชุบุฑ ุดุฏู

### โ Migrations (3 ูุงู)
```
database/migrations/
โโโ 2026_02_14_000001_create_guests_table.php
โ   โโโ guests (ูููุงูุงู ฺฉุชุง)
โ   โโโ personnel_guests (many-to-many)
โโโ 2026_02_14_000002_add_selected_guest_ids_to_lottery_entries.php
    โโโ lottery_entries.selected_guest_ids (ุงูุชุฎุงุจ ูููุงูุงู ุจุฑุง ุณูุฑ)
```

### โ Models (3 ูุงู)
```
app/Models/
โโโ Guest.php (NEW)
โ   โโโ isBankAffiliated()
โ   โโโ findByNationalCode()
โ   โโโ createOrUpdate()
โโโ Personnel.php (MODIFIED)
โ   โโโ guests() relation
โ   โโโ getBankAffiliatedGuestsCount()
โ   โโโ getNonBankAffiliatedGuestsCount()
โโโ LotteryEntry.php (MODIFIED)
    โโโ selected_guest_ids field
    โโโ selectedGuests()
    โโโ getTotalPersonsCount()
```

### โ Controller (1 ูุงู)
```
app/Http/Controllers/
โโโ GuestController.php (NEW)
    โโโ index()    - ูุณุช ูููุงูุงู
    โโโ store()    - ุงูุฒูุฏู ูููุงู
    โโโ show()     - ููุงุด ุฌุฒุฆุงุช
    โโโ update()   - ูุฑุงุด ุงุฏุฏุงุดุช
    โโโ destroy()  - ุญุฐู ุงุฒ ูุณุช
```

### โ Routes (1 ูุงู)
```
routes/web.php (MODIFIED)
โโโ /personnel/{personnel}/guests/*
    โโโ GET    /          - ูุณุช
    โโโ POST   /          - ุงูุฒูุฏู
    โโโ GET    /{guest}   - ููุงุด
    โโโ PATCH  /{guest}   - ูุฑุงุด
    โโโ DELETE /{guest}   - ุญุฐู
```

### โ Views (1 ูุงู)
```
resources/views/personnel/
โโโ show.blade.php (MODIFIED)
โ   โโโ include ุชุจ ูููุงูุงู
โโโ partials/
    โโโ _guests_tab.blade.php (NEW)
        โโโ ูุณุช ูููุงูุงู (Ajax)
        โโโ ููุฏุงู ุงูุฒูุฏู
        โโโ ุนููุงุช CRUD
```

### โ Seeders (1 ูุงู)
```
database/seeders/
โโโ GuestTestSeeder.php (NEW)
    โโโ ุณุงุฎุช 5 ูููุงู ููููู (3 ุจุงูฺฉ + 2 ูุชูุฑูู)
```

### โ Scripts (2 ูุงู)
```
root/
โโโ setup-guest-system.bat (Windows)
โโโ setup-guest-system.sh  (Linux/Mac)
```

### โ Documentation (3 ูุงู)
```
root/
โโโ GUEST_SYSTEM_GUIDE.md            - ุฑุงูููุง ฺฉุงูู
โโโ SETUP_INSTRUCTIONS.md            - ุฏุณุชูุฑุงูุนูู ูุตุจ
โโโ GUEST_SYSTEM_IMPLEMENTATION.md   - ุงู ูุงู
```

---

## ๐๏ธ ุณุงุฎุชุงุฑ ุฏุชุงุจุณ

### ุฌุฏูู `guests`
| ุณุชูู | ููุน | ุชูุถุญ |
|------|-----|-------|
| id | BIGINT | ุดูุงุณู ฺฉุชุง |
| **national_code** | VARCHAR(10) UNIQUE | ฺฉุฏ ูู (ฺฉุชุง) |
| full_name | VARCHAR(255) | ูุงู ฺฉุงูู |
| relation | VARCHAR(50) | ูุณุจุช (ููุณุฑุ ูุฑุฒูุฏุ ...) |
| birth_date | DATE | ุชุงุฑุฎ ุชููุฏ |
| gender | ENUM | ุฌูุณุช (male/female) |
| phone | VARCHAR(20) | ุดูุงุฑู ุชูุงุณ |
| notes | TEXT | ุงุฏุฏุงุดุช |

### ุฌุฏูู `personnel_guests` (pivot)
| ุณุชูู | ููุน | ุชูุถุญ |
|------|-----|-------|
| id | BIGINT | ุดูุงุณู |
| **personnel_id** | BIGINT FK | ุงุฑุฌุงุน ุจู personnel |
| **guest_id** | BIGINT FK | ุงุฑุฌุงุน ุจู guests |
| notes | TEXT | ุงุฏุฏุงุดุช ุงู ุฑุงุจุทู |
| UNIQUE(personnel_id, guest_id) | | ฺฉ ูพุฑุณูู ููโุชูุงูุฏ ฺฉ ูููุงู ุฑุง ุฏูุจุงุฑ ุงุถุงูู ฺฉูุฏ |

### ููุฏ ุฌุฏุฏ ุฏุฑ `lottery_entries`
| ุณุชูู | ููุน | ุชูุถุญ |
|------|-----|-------|
| selected_guest_ids | JSON | ุขุฑุงู IDs: [1,2,3] |

---

## ๐ข ุฏุณุชูโุจูุฏ ูููุงูุงู (9 ููุน)

### โ ุจุงูฺฉ (ุชุนุฑูู ฺฉูุชุฑ) - 6 ููุน
```php
Personnel::RELATION_SPOUSE          // ููุณุฑ
Personnel::RELATION_CHILD           // ูุฑุฒูุฏ
Personnel::RELATION_FATHER          // ูพุฏุฑ
Personnel::RELATION_MOTHER          // ูุงุฏุฑ
Personnel::RELATION_FATHER_IN_LAW   // ูพุฏุฑ ููุณุฑ
Personnel::RELATION_MOTHER_IN_LAW   // ูุงุฏุฑ ููุณุฑ
```

### โ๏ธ ูุชูุฑูู (ุชุนุฑูู ุจุดุชุฑ) - 3 ููุน
```php
Personnel::RELATION_FRIEND          // ุฏูุณุช
Personnel::RELATION_RELATIVE        // ูุงูู
Personnel::RELATION_OTHER           // ุณุงุฑ
```

---

## ๐ ูุญูู ุงุณุชูุงุฏู

### 1. ุฑุงูโุงูุฏุงุฒ (ุงููู ุจุงุฑ)
```bash
# Windows
.\setup-guest-system.bat

# Linux/Mac
chmod +x setup-guest-system.sh
./setup-guest-system.sh
```

### 2. ุชุณุช ุจุง ุฏุงุฏู ููููู (ุงุฎุชุงุฑ)
```bash
docker-compose exec app php artisan db:seed --class=GuestTestSeeder
```

### 3. ุฏุณุชุฑุณ ุจู ุณุณุชู
1. ุจุงุฒ ฺฉูุฏ: http://localhost:8080
2. ูุงฺฏู: admin@bankmelli.ir / password
3. ุจุฑูุฏ ุจู: ูพุฑุณูู โ ุงูุชุฎุงุจ ฺฉ ูพุฑุณูู
4. ุจุฎุด **"ูููุงูุงู"** ุฑุง ุฎูุงูุฏ ุฏุฏ

---

## ๐ ููู ฺฉุงุฑ (User Journey)

### ุณูุงุฑู: ุงูุฒูุฏู ูููุงู
```
1. ูุฏุฑ ุจู ุตูุญู ฺฉ ูพุฑุณูู ูโุฑูุฏ
   โ
2. ุชุจ "ูููุงูุงู" ุฑุง ูโุจูุฏ
   โ
3. ุฑู "ุงูุฒูุฏู ูููุงู" ฺฉูฺฉ ูโฺฉูุฏ
   โ
4. ูุฑู ุจุงุฒ ูโุดูุฏ:
   - ฺฉุฏ ูู (ุณุณุชู ฺฺฉ ูโฺฉูุฏ ุขุง ูุจูุงู ูุฌูุฏ ุฏุงุฑุฏ)
   - ูุงู ฺฉุงูู
   - ูุณุจุช (dropdown ุจุง 9 ฺฏุฒูู)
   - ุฌูุณุชุ ุชุงุฑุฎ ุชููุฏุ ุดูุงุฑู ุชูุงุณ
   - ุงุฏุฏุงุดุช
   โ
5. ุฐุฎุฑู
   โ
6. ุงฺฏุฑ ฺฉุฏ ูู ุฌุฏุฏ ุจุงุดุฏ โ ูููุงู ุฌุฏุฏ ุณุงุฎุชู ูโุดูุฏ
   ุงฺฏุฑ ูุจูุงู ูุฌูุฏ ุฏุงุดุชู โ ูููุงู ููุฌูุฏ ุจู ูุณุช ุงู ูพุฑุณูู ุงุถุงูู ูโุดูุฏ
   โ
7. ูููุงู ุฏุฑ ุฌุฏูู ููุงุด ุฏุงุฏู ูโุดูุฏ ุจุง badge:
   - ๐ข ุจุงูฺฉ (ุณุจุฒ)
   - ๐ก ูุชูุฑูู (ุฒุฑุฏ)
```

### ุณูุงุฑู: ุงุดุชุฑุงฺฉโฺฏุฐุงุฑ ูููุงู
```
ูุซุงู: ูุงุฏุฑ ุจุง ฺฉุฏ ูู 1234567890

ูพุฑุณูู 1 (ุนู):
  โโ ุงูุฒูุฏู ูููุงู: ูุงุฏุฑ (ฺฉุฏ ูู 1234567890)
     โ ูููุงู ุฌุฏุฏ ุณุงุฎุชู ูโุดูุฏ

ูพุฑุณูู 2 (ุญุณู - ุจุฑุงุฏุฑ ุนู):
  โโ ุงูุฒูุฏู ูููุงู: ูุงุฏุฑ (ฺฉุฏ ูู 1234567890)
     โ ุณุณุชู ููุงู ูููุงู ุฑุง ูพุฏุง ูโฺฉูุฏ
     โ ุจู ูุณุช ุญุณู ุงุถุงูู ูโุดูุฏ (attach)
     โ ฺฉ ูููุงูุ ุฏู ูพุฑุณูู โ
```

---

## ๐ API Endpoints

### ูุณุช ูููุงูุงู
```http
GET /personnel/{personnelId}/guests
Accept: application/json

Response:
{
  "guests": [
    {
      "id": 1,
      "national_code": "1234567890",
      "full_name": "ูุงู ูููุงู",
      "relation": "ููุณุฑ",
      "is_bank_affiliated": true,
      "badge_class": "success",
      "badge_text": "ุจุงูฺฉ",
      ...
    }
  ]
}
```

### ุงูุฒูุฏู ูููุงู
```http
POST /personnel/{personnelId}/guests
Content-Type: application/json

{
  "national_code": "1234567890",
  "full_name": "ูุงู ูููุงู",
  "relation": "ููุณุฑ",
  "gender": "male",
  "birth_date": "1370-01-01",
  "phone": "09123456789",
  "notes": "ุงุฏุฏุงุดุช"
}

Response:
{
  "success": true,
  "message": "ูููุงู ุจุง ููููุช ุงุถุงูู ุดุฏ.",
  "guest": { ... }
}
```

### ุญุฐู ูููุงู ุงุฒ ูุณุช
```http
DELETE /personnel/{personnelId}/guests/{guestId}

Response:
{
  "success": true,
  "message": "ูููุงู ุงุฒ ูุณุช ุญุฐู ุดุฏ."
}
```

---

## โ Checklist ูพุงุฏูโุณุงุฒ

### Phase 1: ูพุงูโูุง ุณุณุชู โ (ฺฉุงูู)
- [x] ุงุฌุงุฏ migration ุจุฑุง `guests`
- [x] ุงุฌุงุฏ migration ุจุฑุง `personnel_guests`
- [x] ุงุฌุงุฏ migration ุจุฑุง `selected_guest_ids`
- [x] ุงุฌุงุฏ ูุฏู `Guest`
- [x] ุงุตูุงุญ ูุฏู `Personnel`
- [x] ุงุตูุงุญ ูุฏู `LotteryEntry`
- [x] ุงุฌุงุฏ `GuestController`
- [x] ุงุถุงูู ฺฉุฑุฏู routes
- [x] ุงุฌุงุฏ view ุชุจ ูููุงูุงู
- [x] ุงุชุตุงู ุจู ุตูุญู `personnel/show.blade.php`
- [x] ุงุฌุงุฏ seeders ููููู
- [x] ุงุฌุงุฏ ุงุณฺฉุฑูพุชโูุง ุฑุงูโุงูุฏุงุฒ
- [x] ููุดุชู ูุณุชูุฏุงุช ฺฉุงูู

### Phase 2: ฺฉูพุงุฑฺูโุณุงุฒ ุจุง ูุฑุนูโฺฉุด โณ (ุขูุฏู)
- [ ] UI ุงูุชุฎุงุจ ูููุงูุงู ุฏุฑ lottery entry create/edit
- [ ] ุฐุฎุฑู selected_guest_ids ููฺฏุงู ุซุจุชโูุงู
- [ ] ููุงุด ูููุงูุงู ุงูุชุฎุงุจ ุดุฏู ุฏุฑ lottery entry show
- [ ] ูุญุงุณุจู ุชุนุฏุงุฏ ฺฉู ุงูุฑุงุฏ ุจุฑุง unit assignment
- [ ] ุงุตูุงุญ PriorityScoreService (ุฏุฑ ุตูุฑุช ูุงุฒ)

### Phase 3: ฺฉูพุงุฑฺูโุณุงุฒ ุจุง ุฑุฒุฑู โณ (ุขูุฏู)
- [ ] ฺฉูพ selected_guest_ids ุจู reservation
- [ ] ููุงุด ูููุงูุงู ุฏุฑ voucher
- [ ] ูุณุช ูููุงูุงู ุฏุฑ check-in/check-out
- [ ] ุซุจุช ุฏุฑ usage_history

### Phase 4: ุณุณุชู ูุธููโุจฺฏุฑุงู โณ (ุขูุฏู)
- [ ] ูุทุงุจู `PERSONNEL_GUESTS_SPEC.md`

---

## ๐งช ูุญูู ุชุณุช

### ุชุณุช ุฏุณุช
1. ุฑุงูโุงูุฏุงุฒ Docker ู migration
2. ุจุงุฒ ฺฉุฑุฏู http://localhost:8080
3. ุฑูุชู ุจู ุจุฎุด ูพุฑุณูู
4. ุงูุชุฎุงุจ ฺฉ ูพุฑุณูู
5. ุงูุฒูุฏู ูููุงู ุฌุฏุฏ
6. ุจุฑุฑุณ badge (ุจุงูฺฉ/ูุชูุฑูู)
7. ุญุฐู ูููุงู
8. ุงูุฒูุฏู ููุงู ูููุงู ุจู ูพุฑุณูู ุฏฺฏุฑ (ุชุณุช sharing)

### ุชุณุช ุจุง Tinker
```bash
docker-compose exec app php artisan tinker
```

```php
# ุณุงุฎุช ูููุงู
$guest = \App\Models\Guest::create([
    'national_code' => '9876543210',
    'full_name' => 'ุชุณุช',
    'relation' => 'ููุณุฑ',
]);

# ุงูุชู ูพุฑุณูู
$p = \App\Models\Personnel::first();

# ุงุชุตุงู
$p->guests()->attach($guest->id);

# ุชุณุช
$p->guests;  // ูุณุช ูููุงูุงู
$guest->isBankAffiliated();  // true
$p->getBankAffiliatedGuestsCount();  // ุชุนุฏุงุฏ
```

### ุชุณุช ุจุง Seeder
```bash
docker-compose exec app php artisan db:seed --class=GuestTestSeeder
```

---

## ๐ ูุดฺฉูุงุช ุงุญุชูุงู ู ุฑุงูโุญู

### ูุดฺฉู: Migration failed - "Syntax error"
**ุนูุช:** PostgreSQL ุฏุฑ ุญุงู ุงุฌุฑุง ูุณุช
**ุฑุงู ุญู:**
```bash
docker-compose down
docker-compose up -d
sleep 10
docker-compose exec app php artisan migrate
```

### ูุดฺฉู: "419 Page Expired" ุฏุฑ ุงูุฒูุฏู ูููุงู
**ุนูุช:** CSRF token ูููุถ ุดุฏู
**ุฑุงู ุญู:** ุฑูุฑุด ุตูุญู ู ุฏูุจุงุฑู ุชูุงุด

### ูุดฺฉู: "Guest already added"
**ุนูุช:** ุงู ูููุงู ูุจูุงู ุจู ูุณุช ุงุถุงูู ุดุฏู
**ุฑุงู ุญู:** ุงู ุฑูุชุงุฑ ุตุญุญ ุงุณุช. ฺฉ ูููุงู ููโุชูุงูุฏ ุฏูุจุงุฑ ุจู ฺฉ ูพุฑุณูู ุงุถุงูู ุดูุฏ.

### ูุดฺฉู: ุชุจ ูููุงูุงู ููุงุด ุฏุงุฏู ููโุดูุฏ
**ุนูุช:** Cache
**ุฑุงู ุญู:**
```bash
docker-compose exec app php artisan view:clear
docker-compose exec app php artisan cache:clear
```

---

## ๐ ุขูุงุฑ ูพุงุฏูโุณุงุฒ

- **ูุงูโูุง ุฌุฏุฏ:** 14
- **ูุงูโูุง ุงุตูุงุญ ุดุฏู:** 4
- **ุฎุทูุท ฺฉุฏ ุฌุฏุฏ:** ~1,200
- **Migrations:** 2
- **Models:** 1 ุฌุฏุฏ + 2 ุงุตูุงุญ
- **Controllers:** 1 ุฌุฏุฏ
- **Views:** 1 ุฌุฏุฏ + 1 ุงุตูุงุญ
- **Routes:** 5 endpoint
- **ุฒูุงู ูพุงุฏูโุณุงุฒ:** ~3 ุณุงุนุช

---

## ๐ ูฺฉุงุช ููู ุจุฑุง ุชูุณุนูโุฏููุฏฺฏุงู

### 1. ูููุงู ฺฉุชุง ุงุณุช
```php
// ููุดู ุงุฒ national_code ุงุณุชูุงุฏู ฺฉูุฏ
$guest = Guest::findByNationalCode('1234567890');
```

### 2. ฺฉ ูููุงูุ ฺูุฏ ูพุฑุณูู
```php
// ูููุงู ุจุง ID=1 ูโุชูุงูุฏ ุจุง ฺูุฏ ูพุฑุณูู ูุฑุชุจุท ุจุงุดุฏ
$guest->personnel;  // Collection of Personnel
```

### 3. ุฏุณุชูโุจูุฏ ุฎูุฏฺฉุงุฑ
```php
$guest->isBankAffiliated();  // bool
Personnel::isFamilyMemberBankAffiliated('ููุณุฑ');  // true
Personnel::isFamilyMemberBankAffiliated('ุฏูุณุช');  // false
```

### 4. Soft Delete ูุฏุงุฑู
- ุญุฐู ูุงูุน ุงูุฌุงู ูโุดูุฏ (detach)
- ุงฺฏุฑ ูุงุฒ ุจู ุชุงุฑุฎฺู ุงุณุชุ ุจุงุฏ reservation_guests ุฑุง ูฺฏู ุฏุงุฑุฏ

---

## ๐ ูพุดุชุจุงู

ุจุฑุง ุณุคุงูุงุช:
1. ูุณุชูุฏุงุช: `GUEST_SYSTEM_GUIDE.md`
2. ูุตุจ: `SETUP_INSTRUCTIONS.md`
3. ูุดุฎุตุงุช: `PERSONNEL_GUESTS_SPEC.md`

---

**โ Phase 1 ุชฺฉูู ุดุฏ - ุขูุงุฏู ุงุณุชูุงุฏู!**

*ุขุฎุฑู ุจูโุฑูุฒุฑุณุงู: 1404/11/26 - 15:30*
