================================================================================
          گزارش کامل وضعیت پروژه و راهنمای اتصال به سرور
                    سامانه رفاهی بانک ملی ایران
                       تاریخ: 1404/10/30
================================================================================

================================================================================
بخش اول: اطلاعات سرور
================================================================================

سرور اصلی:
  • IP: 37.152.174.87
  • سیستم عامل: Ubuntu 22.04.5 LTS
  • پورت SSH: 22
  • پورت وب: 8083
  • مسیر پروژه: /var/www/welfare

================================================================================
بخش دوم: راهنمای اتصال به سرور با SSH
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│ روش 1: اتصال با کلید SSH (توصیه شده)                                        │
└─────────────────────────────────────────────────────────────────────────────┘

1. کلید عمومی SSH (برای اضافه کردن به سرور):
--------------------------------------------------------------------------------
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCmwoyufOV0D6G0ZdnBDeZu4st5SZy7etbObA7DQUMFuHCieAwI8I2cKz6fqm4aBnXzA3Gxy3DAyiTn8CnmB+4gphF0rnhyRAR1zEywl3labeoBpYUOjna/EJfmLeytL6JH+TW6EXbUKFI0JixNiTu189gLGKlFp5reBBEY2t4BLKPF2162ExaHdd/ypBOTpvbaNqvY3Ty0im1iZYHRDdZi487m+H7NSM2HZAY8Xpo/FCnIx4nghvVDKnJKWM3xM91Zbf3xSBQCMH/iniyMeaBSjG3n9CGsJLi5QD1pjPy9dypVIUuAjhB+lyZT8ENslVHHykWCzBRNn8t8sSyvkWLYUXTd6ic9fKzTT+Kqvdf8lv4h0XDQE/iwXnbFDZH1r3p7+6ojjsdFBXXN1ljmr80ijL4dTBKtaVVv8SFIasHU1L2sQzJ919i5f9rPQfD0BtQVyHqWH/+ElGNSX/Mhl7GRHGJKXxr4eNThWST7tOx+6+79DDR/iYs9OZpkrlKRSbezeTpI0/xJtTqK4nBSSTYKEw1GdUAxUJyax6hQq5qg7iNCTy6vWi4RTjRP7id2jQc1f96fXZ7iVjF3+rXbNtXSEfRnSsRrhPOfi0FuyFBH6lc9E1kx/NoRjelqKO8Xtvpqy5OO+vTgIHY+dTbcBwnK/6mdUuawHgFFQJ5W+DwnEQ== sedal@sedal021
--------------------------------------------------------------------------------

2. دستور اتصال:
   ssh -i ~/.ssh/id_rsa root@37.152.174.87

3. برای اضافه کردن کلید به سرور (یکبار):
   ssh-copy-id -i ~/.ssh/id_rsa.pub root@37.152.174.87

┌─────────────────────────────────────────────────────────────────────────────┐
│ روش 2: اتصال با رمز عبور                                                    │
└─────────────────────────────────────────────────────────────────────────────┘

   ssh root@37.152.174.87
   # سپس رمز عبور را وارد کنید

┌─────────────────────────────────────────────────────────────────────────────┐
│ تنظیمات SSH Config (برای راحتی)                                             │
└─────────────────────────────────────────────────────────────────────────────┘

فایل: ~/.ssh/config
محتوا:
--------------------------------------------------------------------------------
Host welfare-server
    HostName 37.152.174.87
    User root
    IdentityFile ~/.ssh/id_rsa
    Port 22
--------------------------------------------------------------------------------

بعد از تنظیم، فقط کافیست بنویسید:
   ssh welfare-server

================================================================================
بخش سوم: دستورات کاربردی روی سرور
================================================================================

# رفتن به مسیر پروژه
cd /var/www/welfare

# مشاهده وضعیت Docker
docker-compose ps

# مشاهده لاگ‌ها
docker-compose logs -f app

# ری‌استارت سرویس‌ها
docker-compose restart

# اجرای migration
docker-compose exec app php artisan migrate

# پاک کردن کش
docker-compose exec app php artisan cache:clear
docker-compose exec app php artisan config:clear
docker-compose exec app php artisan view:clear

# ورود به شل کانتینر
docker-compose exec app bash

================================================================================
بخش چهارم: وضعیت فعلی پروژه
================================================================================

درصد پیشرفت کلی: حدود 40%

ماژول‌های تکمیل شده:
  [✓] مراکز رفاهی (Centers) - CRUD کامل
  [✓] واحدها (Units) - CRUD کامل با 426 واحد
  [✓] دوره‌ها (Periods) - CRUD کامل با تاریخ شمسی
  [✓] سایدبار و لایه‌آوت - طراحی مدرن

ماژول‌های باقی‌مانده:
  [ ] قرعه‌کشی (Lottery)
  [ ] رزروها (Reservations)
  [ ] پرسنل (Personnel)
  [ ] استان‌ها (Provinces)
  [ ] گزارش‌ها (Reports)

داده‌های موجود:
  • 3 مرکز رفاهی (مشهد، بابلسر، چادگان)
  • 426 واحد (1781 تخت)
  • فصل‌ها و تعرفه‌ها تعریف شده

================================================================================
بخش پنجم: مشکلات شناسایی شده
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│ مشکلات بحرانی (Critical) - 2 مورد                                          │
└─────────────────────────────────────────────────────────────────────────────┘

1. عدم Authorization (مجوزدهی)
   ─────────────────────────────
   وضعیت: ❌ بحرانی
   توضیح: هر کاربری که لاگین کرده باشد به تمام قسمت‌های سیستم دسترسی دارد.

   مشکل:
     • کاربر عادی می‌تواند به پنل ادمین دسترسی داشته باشد
     • عدم بررسی سطح دسترسی در Controller ها
     • هر کاربر می‌تواند اطلاعات را حذف/ویرایش کند

   راه‌حل پیشنهادی:
     • پیاده‌سازی Policy های Laravel
     • استفاده از Gate برای بررسی دسترسی
     • اضافه کردن middleware به route ها

   فایل‌های نیازمند تغییر:
     • app/Http/Controllers/*.php
     • app/Policies/*.php (ایجاد)

2. عدم Role-based Access در Routes
   ─────────────────────────────────
   وضعیت: ❌ بحرانی
   توضیح: Route ها بدون محدودیت نقش تعریف شده‌اند.

   مشکل:
     • middleware های role/permission استفاده نشده
     • همه Route ها فقط auth:sanctum دارند
     • Spatie Permission نصب شده ولی استفاده نشده

   راه‌حل پیشنهادی:
     • اضافه کردن middleware('role:admin') به route های ادمین
     • تعریف permission برای هر عملیات
     • گروه‌بندی route ها بر اساس نقش

   فایل‌های نیازمند تغییر:
     • routes/web.php
     • routes/api.php

┌─────────────────────────────────────────────────────────────────────────────┐
│ مشکلات متوسط (Medium) - 7 مورد                                              │
└─────────────────────────────────────────────────────────────────────────────┘

1. Validation ناقص در toggleStatus
   ─────────────────────────────────
   وضعیت: ⚠️ متوسط
   توضیح: متد toggleStatus در Controller ها validation ندارد.

   مشکل:
     • عدم بررسی وجود رکورد قبل از تغییر
     • عدم بررسی شرایط کسب‌وکاری (مثلاً مرکز دارای رزرو فعال)

   راه‌حل:
     • اضافه کردن validation rules
     • بررسی وابستگی‌ها قبل از غیرفعال‌سازی

2. مشکل N+1 Query در CenterController
   ─────────────────────────────────────
   وضعیت: ⚠️ متوسط
   توضیح: در لیست مراکز، برای هر مرکز کوئری جداگانه زده می‌شود.

   مشکل:
     Center::all() → برای هر مرکز units count جدا

   راه‌حل:
     Center::withCount('units')->get()

3. کوئری‌های تکراری در updateCenterCounts
   ─────────────────────────────────────────
   وضعیت: ⚠️ متوسط
   توضیح: هر بار که واحد اضافه/حذف می‌شود، کل واحدها شمرده می‌شوند.

   راه‌حل:
     • استفاده از increment/decrement به جای شمارش مجدد
     • یا استفاده از Observer

4. عدم استفاده از Cache
   ───────────────────────
   وضعیت: ⚠️ متوسط
   توضیح: داده‌های ثابت مثل لیست مراکز هر بار از دیتابیس خوانده می‌شوند.

   راه‌حل:
     Cache::remember('centers', 3600, fn() => Center::all())

5. عدم استفاده از Form Request
   ─────────────────────────────
   وضعیت: ⚠️ متوسط
   توضیح: Validation در Controller ها نوشته شده به جای Form Request.

   مشکل:
     • کد تکراری
     • سخت‌تر شدن نگهداری
     • عدم جداسازی concerns

   راه‌حل:
     • ایجاد StoreCenterRequest, UpdateCenterRequest و...

6. تکرار Validation Rules
   ────────────────────────
   وضعیت: ⚠️ متوسط
   توضیح: قوانین validation در store و update تکرار شده‌اند.

   راه‌حل:
     • تعریف rules در Model یا Form Request مشترک

7. Fat Controller در PeriodController
   ─────────────────────────────────────
   وضعیت: ⚠️ متوسط
   توضیح: Controller حجیم شده و منطق کسب‌وکار داخلش نوشته شده.

   مشکل:
     • تبدیل تاریخ شمسی در Controller
     • محاسبه کد دوره در Controller
     • بیش از 200 خط کد

   راه‌حل:
     • انتقال منطق به Service (PeriodService)
     • استفاده از Action classes
     • جداسازی تبدیل تاریخ به Helper

================================================================================
بخش ششم: اولویت‌بندی رفع مشکلات
================================================================================

فوری (قبل از Production):
  1. ❌ پیاده‌سازی Authorization و Policy ها
  2. ❌ اضافه کردن Role middleware به Routes

بعد از رفع مشکلات بحرانی:
  3. ⚠️ رفع N+1 Query ها
  4. ⚠️ پیاده‌سازی Cache
  5. ⚠️ ایجاد Form Request ها
  6. ⚠️ Refactor کردن Fat Controllers
  7. ⚠️ بهبود Validation

================================================================================
بخش هفتم: نقش‌های کاربری (تعریف شده در سیستم)
================================================================================

نقش              │ فارسی           │ دسترسی
─────────────────┼─────────────────┼──────────────────────────────
super_admin      │ مدیر سیستم      │ همه چیز
admin            │ ادمین اداره کل  │ مراکز، قرعه‌کشی، گزارشات
provincial_admin │ مدیر استانی     │ تایید/رد، گزارشات استانی
operator         │ اپراتور         │ مشاهده، ورود داده
user             │ همکار           │ ثبت‌نام، مشاهده نتایج

================================================================================
بخش هشتم: لینک‌های مفید
================================================================================

پنل ادمین: http://37.152.174.87:8083/admin
API: http://37.152.174.87:8083/api

کاربر پیش‌فرض:
  ایمیل: admin@bankmelli.ir
  رمز: password

================================================================================
                              پایان گزارش
================================================================================
